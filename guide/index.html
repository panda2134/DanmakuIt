<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>开始使用 | 弹幕一下</title>
    <meta name="description" content="弹幕一下文档">
    <link rel="stylesheet" href="/assets/style.0e90491c.css">
    <link rel="modulepreload" href="/assets/Home.93f6475d.js">
    <link rel="modulepreload" href="/assets/app.f396f5fb.js">
    <link rel="modulepreload" href="/assets/index.ccd2a8df.js">
    <link rel="modulepreload" href="/assets/guide_index.md.9e12913a.lean.js">
    
    <meta name="twitter:title" content="开始使用 | 弹幕一下">
    <meta property="og:title" content="开始使用 | 弹幕一下">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-40587210><div class="sidebar-button" data-v-40587210><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="弹幕一下, back to home" data-v-40587210 data-v-7ac13a1e><!----> 弹幕一下</a><div class="flex-grow" data-v-40587210></div><div class="nav" data-v-40587210><!----></div><!--[--><!--]--></header><aside class="sidebar" data-v-17c48e2f><!----><!--[--><!--]--><ul class="sidebar-links" data-v-17c48e2f><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#开始使用">开始使用</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#准备工作">准备工作</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#安装-docker-docker-compose">安装 docker &amp; docker-compose</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#安装-caddy">安装 caddy</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#配置自动审核">配置自动审核</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#配置oauth">配置OAuth</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#下载和配置弹幕一下">下载和配置弹幕一下</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#配置桌面客户端">配置桌面客户端</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h2 id="开始使用" tabindex="-1">开始使用 <a class="header-anchor" href="#开始使用" aria-hidden="true">#</a></h2><p>弹幕一下是一款开源的弹幕投屏系统，其具有如下特点：</p><ul><li>支持多种投屏方式，如屏上的滚动弹幕、弹幕墙等</li><li>通过接入微信公众号进行弹幕投屏，方便快捷</li><li>管理功能强大，除使用自动审核外，管理员可以手动审核弹幕</li></ul><h3 id="准备工作" tabindex="-1">准备工作 <a class="header-anchor" href="#准备工作" aria-hidden="true">#</a></h3><p>要部署弹幕一下，你需要如下的准备：</p><ul><li>一台80，443端口对外可用的服务器，其需有 HTTPS 证书； <ul><li>如果你不知道如何申请证书，可以参考 <a href="https://caddyserver.com/docs/automatic-https" target="_blank" rel="noopener noreferrer">这里</a>；后文也会详细介绍</li></ul></li><li>一个域名，解析到上述服务器，用于申请 HTTPS 证书</li><li>一个微信公众号，用于接入弹幕一下；测试阶段，可以采用微信接口测试号 <ul><li>测试号可在 <a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="noopener noreferrer">这里</a> 申请</li></ul></li></ul><p>在下文中，我们假设服务器上运行 Ubuntu 20.04.</p><h3 id="安装-docker-docker-compose" tabindex="-1">安装 docker &amp; docker-compose <a class="header-anchor" href="#安装-docker-docker-compose" aria-hidden="true">#</a></h3><p>首先，在服务器上安装 <code>docker</code> 和 <code>docker-compose</code>。注意 sudo 可能需要输入密码。</p><div class="language-shell line-numbers-mode"><pre><code><span class="token comment"># 安装 docker</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg <span class="token punctuation">\</span>
<span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
<span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
  <span class="token string">&quot;deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y docker-ce docker-ce-cli containerd.io
<span class="token function">sudo</span> docker run hello-world  <span class="token comment"># 测试是否安装成功</span>

<span class="token comment"># 安装 docker-compose</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L <span class="token string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span>&quot;</span> -o /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/bin/docker-compose /usr/bin/docker-compose
docker-compose --version  <span class="token comment"># 出现版本，则安装成功</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="安装-caddy" tabindex="-1">安装 caddy <a class="header-anchor" href="#安装-caddy" aria-hidden="true">#</a></h3><p>Caddy 是一个以 Go 编写的开源 HTTP 服务器，支持 HTTP/2 和自动 HTTPS。 我们推荐使用 Caddy 进行 HTTPS 流量的反向代理，因为其配置较为简易。</p><p>首先安装 Caddy:</p><div class="language-shell line-numbers-mode"><pre><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y debian-keyring debian-archive-keyring apt-transport-https
<span class="token function">curl</span> -1sLf <span class="token string">&#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/trusted.gpg.d/caddy-stable.asc
<span class="token function">curl</span> -1sLf <span class="token string">&#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/caddy-stable.list
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> caddy
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>假设你服务器的 IP 地址为 <code>12.34.56.78</code>，域名为 <code>danmakuit.example.com</code>，你需要首先配置域名解析到服务器的 IP 地址（使用 A 记录或 AAAA 记录）。 待确认解析正常后，向 <code>/etc/caddy/Caddyfile</code> 写入如下内容：</p><div class="language-caddyfile line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code>danmakuit.example.com {  # **注意**：改为你自己的域名！！
    tls mail@example.com #          改为你自己的邮箱，用于申请 Let&#39;s Encrypt 证书。
    respond &quot;Hello, world!&quot;   ## &lt;- 用来测试，之后需要改为反向代理
    encode gzip
}
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>在自己服务器上部署时，务必把域名和邮箱改为自己的，否则会导致证书申请失败。</p></div><p>然后，重新加载 Caddy：</p><div class="language-shell line-numbers-mode"><pre><code><span class="token function">sudo</span> systemctl reload caddy
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在浏览器中访问你自己的域名，应该可以看到 <code>Hello, world!</code>，且地址栏显示为安全的 HTTPS 连接。</p><h3 id="配置自动审核" tabindex="-1">配置自动审核 <a class="header-anchor" href="#配置自动审核" aria-hidden="true">#</a></h3><p>目前，我们使用百度提供的文本远程审核接口，其免费额度足以普通用户使用；在关闭自动审核时，默认拒绝投屏所有的文本。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>在未来版本，我们会支持更加宽松的审核策略，如在关闭自动时采用黑名单策略，即对不匹配关键词的弹幕直接予以通过。</p></div><p>首先，按照百度智能云的<a href="https://ai.baidu.com/ai-doc/REFERENCE/Ck3dwjgn3" target="_blank" rel="noopener noreferrer">文档</a>， 在进入内容审核产品页面后，创建一个内容审核应用程序，并且获得其对应 API Key 和 Secret Key。记录这两个 Key 用于之后的设置。</p><p><img src="/assets/baidu-censor1.e319e471.png" alt="baidu-censor1"></p><h3 id="配置oauth" tabindex="-1">配置OAuth <a class="header-anchor" href="#配置oauth" aria-hidden="true">#</a></h3><p>目前支持 GitHub 和 GitLab 的 OAuth 作为管理平台登录方式。</p><h4 id="github" tabindex="-1">GitHub <a class="header-anchor" href="#github" aria-hidden="true">#</a></h4><p>点击右上角头像，在 Settings 页面左侧找到 Developer settings，点击 OAuth Apps &gt; New OAuth App 以创建一个新的 Application，设置为：</p><ul><li>Application Name: 任意</li><li>Homepage URL: 网站域名</li><li>Authorization callback URL: <code>https://你的网站域名/api/v1/user/social-login/github/auth</code></li></ul><p>然后保存应用程序，并记录 Application ID 和 Secret.</p><h4 id="gitlab-官方-自托管" tabindex="-1">GitLab (官方/自托管) <a class="header-anchor" href="#gitlab-官方-自托管" aria-hidden="true">#</a></h4><p>点击右上角头像，在 Edit Profile 页面左侧找到 Applications 以创建一个新的 Application，设置为：</p><ul><li>Name: 任意</li><li>Redirect URI: <ul><li>对官方 GitLab，为 <code>https://你的网站域名/api/v1/user/social-login/gitlab/auth</code></li><li>对自托管 GitLab，为 <code>https://你的网站域名/api/v1/user/social-login/gitlab3rd/auth</code></li></ul></li><li>Confidential: 勾选</li><li>Scopes: 勾选 read_user</li></ul><p>然后保存应用程序，并记录 Application ID 和 Secret.</p><h3 id="下载和配置弹幕一下" tabindex="-1">下载和配置弹幕一下 <a class="header-anchor" href="#下载和配置弹幕一下" aria-hidden="true">#</a></h3><p>运行以下命令：</p><div class="language-shell line-numbers-mode"><pre><code><span class="token function">git</span> clone https://github.com/panda2134/DanmakuIt.git
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后需要生成配置文件。 由于配置文件较多，这里提供了一个用于生成密码文件的工具。其中，已有值的项为自动生成。 填写好表格后，点击“下载配置”并解压压缩包，以压缩包内 <code>*.env</code> 文件覆盖repo中同名文件内容即可。</p><div class="tip custom-block"><p class="custom-block-title">配置生成工具</p><!--[--><form action="" style="margin:1rem 0;"><h4 style="margin-bottom:0.5rem;">api.env</h4><!--[--><div style="display:flex;margin-bottom:0.3rem;"><label for="BAIDU_CLIENT_ID" style="margin-right:0.5rem;flex-grow:0;">百度云文本审核 API Key</label><input value="" name="BAIDU_CLIENT_ID" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="BAIDU_CLIENT_SECRET" style="margin-right:0.5rem;flex-grow:0;">百度云文本审核 Secret Key</label><input value="" name="BAIDU_CLIENT_SECRET" style="flex-grow:1;"></div><!--]--></form><form action="" style="margin:1rem 0;"><h4 style="margin-bottom:0.5rem;">site.env</h4><!--[--><div style="display:flex;margin-bottom:0.3rem;"><label for="MONGO_INITDB_ROOT_USERNAME" style="margin-right:0.5rem;flex-grow:0;">MongoDB 数据库名称</label><input value="danmakuit" name="MONGO_INITDB_ROOT_USERNAME" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="MONGO_INITDB_ROOT_PASSWORD" style="margin-right:0.5rem;flex-grow:0;">MongoDB 数据库密码</label><input value="" name="MONGO_INITDB_ROOT_PASSWORD" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="WEB_ORIGIN" style="margin-right:0.5rem;flex-grow:0;">网站外部访问域名和协议（要求https）</label><input value="" name="WEB_ORIGIN" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="SESSION_SECRET" style="margin-right:0.5rem;flex-grow:0;">会话密钥</label><input value="" name="SESSION_SECRET" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="JWT_SECRET" style="margin-right:0.5rem;flex-grow:0;">JWT密钥</label><input value="" name="JWT_SECRET" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITHUB_APPID" style="margin-right:0.5rem;flex-grow:0;">GitHub App ID</label><input value="" name="GITHUB_APPID" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITHUB_SECRET" style="margin-right:0.5rem;flex-grow:0;">GitHub App Secret</label><input value="" name="GITHUB_SECRET" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITLAB_APPID" style="margin-right:0.5rem;flex-grow:0;">GitLab App ID</label><input value="" name="GITLAB_APPID" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITLAB_SECRET" style="margin-right:0.5rem;flex-grow:0;">GitLab App Secret</label><input value="" name="GITLAB_SECRET" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITLAB_3RD_BASEURL" style="margin-right:0.5rem;flex-grow:0;">自托管 GitLab 实例地址</label><input value="" name="GITLAB_3RD_BASEURL" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITLAB_3RD_APPID" style="margin-right:0.5rem;flex-grow:0;">自托管 GitLab 实例 App ID</label><input value="" name="GITLAB_3RD_APPID" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="GITLAB_3RD_APPSECRET" style="margin-right:0.5rem;flex-grow:0;">自托管 GitLab 实例 App Secret</label><input value="" name="GITLAB_3RD_APPSECRET" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="ALLOW_REGISTRATION" style="margin-right:0.5rem;flex-grow:0;">是否允许注册，1为允许，0为不允许</label><input value="" name="ALLOW_REGISTRATION" style="flex-grow:1;"></div><!--]--></form><form action="" style="margin:1rem 0;"><h4 style="margin-bottom:0.5rem;">token.env</h4><!--[--><div style="display:flex;margin-bottom:0.3rem;"><label for="WECHAT_TOKEN_LEN" style="margin-right:0.5rem;flex-grow:0;">微信公众号验证所用的token长度</label><input value="12" name="WECHAT_TOKEN_LEN" style="flex-grow:1;"></div><div style="display:flex;margin-bottom:0.3rem;"><label for="WECHAT_TOKEN_SALT" style="margin-right:0.5rem;flex-grow:0;">用于内部生成Token的盐值</label><input value="" name="WECHAT_TOKEN_SALT" style="flex-grow:1;"></div><!--]--></form><!--]--><button style="margin-bottom:1em;">下载配置</button></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>不建议在第一次运行前禁用新用户注册，否则将无人可以注册账户；建议待所有人注册完成后，在 <code>site.env</code> 中禁用，再运行</p><div class="language-shell line-numbers-mode"><pre><code>docker-compose down
docker-compose up -d
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>以重启服务。</p></div><p>上传配置后，设置 <code>/etc/caddy/Caddyfile</code>，<strong>修改</strong> 为：</p><div class="language-caddyfile line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br></div><pre><code>danmakuit.example.com {  # **注意**：改为你自己的域名！！
    tls mail@example.com #          改为你自己的邮箱，用于申请 Let&#39;s Encrypt 证书。
    reverse_proxy localhost:8000   ## 反向代理
    encode gzip
}
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>正式运行弹幕一下前，需要如上正确配置反向代理，否则将无法从外部以HTTPS访问。</p></div><p>然后正式运行：</p><div class="language-shell line-numbers-mode"><pre><code><span class="token builtin class-name">cd</span> DanmakuIt  <span class="token comment"># 切换到源代码所在目录</span>
docker-compose up -d --build
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>等待数分钟后访问你的服务器域名，应该可以看到服务器已经上线。</p><p><img src="/assets/running.22feb44e.png" alt="Running DanmakuIt"></p><p>Enjoy it!</p><h3 id="配置桌面客户端" tabindex="-1">配置桌面客户端 <a class="header-anchor" href="#配置桌面客户端" aria-hidden="true">#</a></h3><p>TODO: CI &amp; config</p></div></div><footer class="page-footer" data-v-8fcebc32 data-v-5c96fb00><div class="edit" data-v-5c96fb00><div class="edit-link" data-v-5c96fb00 data-v-55695e90><!----></div></div><div class="updated" data-v-5c96fb00><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"guide_index.md\":\"9e12913a\",\"guide_maintainance.md\":\"351f6de1\",\"guide_message_format.md\":\"ef1bd78f\",\"index.md\":\"2bf16652\"}")</script>
    <script type="module" async src="/assets/app.f396f5fb.js"></script>
    
  </body>
</html>